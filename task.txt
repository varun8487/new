                                                    Mahle- SOW

similar to this we are going to create first: 

  

Build a custom Ubuntu image with Packer 

Provision a VM from that image with Terraform 

Parameterize everything for repeatability 

Run & validate locally (and easily move into a pipeline later) 

Assumptions (adjust as needed): 

Azure subscription ready; you have az CLI installed and logged in (az login). 

You‚Äôll use a Managed Image first (simpler), then you can switch to Shared Image Gallery (SIG) if needed. 

Base image: Ubuntu 22.04 LTS (Gen2). 

0) Create a clean repo layout 

  

mkdir azure-image-poc && cd azure-image-poc 

mkdir -p packer/ubuntu/scripts terraform/envs/dev 

touch README.md 

  

Repo tree 

Plain Text 

azure-image-poc/ 

‚îú‚îÄ packer/ 

‚îÇ  ‚îî‚îÄ ubuntu/ 

‚îÇ     ‚îú‚îÄ variables.pkr.hcl 

‚îÇ     ‚îú‚îÄ ubuntu.pkr.hcl 

‚îÇ     ‚îî‚îÄ scripts/ 

‚îÇ        ‚îú‚îÄ base.sh 

‚îÇ        ‚îî‚îÄ xrdp.sh    # optional, only if you want RDP-ready image 

‚îî‚îÄ terraform/ 

   ‚îú‚îÄ main.tf 

   ‚îú‚îÄ variables.tf 

   ‚îú‚îÄ outputs.tf 

   ‚îî‚îÄ envs/ 

      ‚îî‚îÄ dev/ 

         ‚îî‚îÄ terraform.tfvars 

Add a .gitignore: 

Plain Text 

*.tfstate 

*.tfstate.backup 

.terraform/ 

*.log 

*.pem 

*.pkrvars.hcl 

 

 

1) Create a Service Principal for Packer & Terraform 

Scope to a resource group to keep least-privilege for POC. 

  

# Replace IDs/names 

SUBID="<your-subscription-id>" 

LOCATION="eastus" 

IMAGERG="rg-image-poc" 

TEMPRG="rg-packer-temp" 

 

 

az group create -n $IMAGERG -l $LOCATION 

az group create -n $TEMPRG  -l $LOCATION 

  

az ad sp create-for-rbac \ 

  --name "sp-packer-terraform-poc" \ 

  --role Contributor \ 

  --scopes /subscriptions/$SUBID/resourceGroups/$IMAGE_RG \ 

  --sdk-auth 

`` 

  

Copy the output JSON values: 

clientId, clientSecret, tenantId, subscriptionId 

You‚Äôll use these in Packer variables and in Terraform azurerm provider. 

2) Packer ‚Äî build the custom Ubuntu image 

2.1 Variables (packer/ubuntu/variables.pkr.hcl) 

  

variable "subscriptionid" { type = string } 

variable "tenantid"       { type = string } 

variable "clientid"       { type = string } 

variable "clientsecret"   { type = string, sensitive = true } 

  

variable "location"        { type = string  default = "eastus" } 

variable "imagerg"        { type = string  default = "rg-image-poc" } 

variable "imagename"      { type = string  default = "img-ubuntu-22" } 

variable "temprg"         { type = string  default = "rg-packer-temp" } 

variable "vmsize"         { type = string  default = "StandardD2sv5" } 

  

# Base Ubuntu (Canonical) 

variable "publisher" { type = string default = "Canonical" } 

variable "offer"     { type = string default = "0001-com-ubuntu-server-jammy" } 

variable "sku"       { type = string default = "22_04-lts-gen2" } 

`` 

  

2.2 Packer template (packer/ubuntu/ubuntu.pkr.hcl) 

  

packer { 

  requiredplugins { 

    azure = { 

      source  = "github.com/hashicorp/azure" 

      version = ">= 2.0.0" 

    } 

  } 

} 

  

source "azure-arm" "ubuntu" { 

  subscriptionid = var.subscriptionid 

  clientid       = var.clientid 

  clientsecret   = var.clientsecret 

  tenantid       = var.tenantid 

 

 

  ostype   = "Linux" 

  location  = var.location 

  vmsize   = var.vmsize 

  

  # Base image (marketplace) 

  imagepublisher = var.publisher 

  imageoffer     = var.offer 

  imagesku       = var.sku 

  

  # Output managed image 

  managedimageresourcegroupname = var.imagerg 

  managedimagename                = var.imagename 

  

  # Temporary build resources 

  buildresourcegroupname = var.temprg 

  

  communicator = "ssh" 

  sshusername = "azureuser" 

  

  azure_tags = { 

    Project     = "ImagePOC" 

    Owner       = "DevOps" 

    Environment = "Dev" 

  } 

} 

  

build { 

  name    = "ubuntu-22-image" 

  sources = ["source.azure-arm.ubuntu"] 

  

  # Baseline provisioning 

  provisioner "shell" { 

    script = "scripts/base.sh" 

  } 

  

  # Optional: RDP-ready image (uncomment if you want it baked-in) 

  # provisioner "shell" { 

  #   script = "scripts/xrdp.sh" 

  # } 

} 

`` 

  

2.3 Provisioner scripts 

packer/ubuntu/scripts/base.sh 

  

#!/usr/bin/env bash 

set -euo pipefail 

  

sudo apt-get update -y 

sudo apt-get dist-upgrade -y 

sudo apt-get install -y curl jq unzip htop net-tools 

  

# Enable password auth for quick POC (harden later) 

sudo sed -i 's/^#PasswordAuthentication./PasswordAuthentication yes/' /etc/ssh/sshd_config 

sudo systemctl restart ssh 

  

echo "Image build timestamp: $(date)" | sudo tee /etc/image-build-info 

  

packer/ubuntu/scripts/xrdp.sh (optional) 

  

#!/usr/bin/env bash 

set -euo pipefail 

  

sudo apt-get update -y 

sudo apt-get install -y xrdp xfce4 xfce4-goodies 

  

# Default session 

echo "xfce4-session" | sudo tee /etc/skel/.xsession 

  

# Xwrapper fix 

if [ -f /etc/X11/Xwrapper.config ]; then 

  sudo sed -i 's/allowedusers=console/allowedusers=anybody/' /etc/X11/Xwrapper.config || true 

fi 

  

sudo systemctl enable xrdp 

sudo systemctl restart xrdp 

  

2.4 Run Packer 

  

cd packer/ubuntu 

  

packer init . 

packer fmt . 

packer validate \ 

  -var "subscriptionid=$SUBID" \ 

  -var "tenantid=<TENANTID>" \ 

  -var "clientid=<CLIENTID>" \ 

  -var "clientsecret=<CLIENTSECRET>" \ 

  . 

  

packer build \ 

  -var "subscriptionid=$SUBID" \ 

  -var "tenantid=<TENANTID>" \ 

  -var "clientid=<CLIENTID>" \ 

  -var "clientsecret=<CLIENTSECRET>" \ 

  . 

  

Result: Managed Image img-ubuntu-22 in rg-image-poc. 

‚úÖ Tip: If you prefer Shared Image Gallery, we can switch to azure-sig post-processor later. 

3) Terraform ‚Äî create network + VM from the image 

3.1 terraform/main.tf 

  

terraform { 

  requiredversion = ">= 1.6.0" 

  requiredproviders { 

    azurerm = { 

      source  = "hashicorp/azurerm" 

      version = "~> 3.114" 

    } 

    random = { 

      source  = "hashicorp/random" 

      version = "~> 3.6" 

    } 

  } 

} 

  

provider "azurerm" { 

  features {} 

  subscriptionid = var.subscriptionid 

  tenantid       = var.tenantid 

  clientid       = var.clientid 

  clientsecret   = var.clientsecret 

} 

  

# Resource Group (reuse the same RG as images for POC or create separate) 

resource "azurermresourcegroup" "rg" { 

  name     = var.rgname 

  location = var.location 

  tags     = var.tags 

} 

  

# Networking 

resource "azurermvirtualnetwork" "vnet" { 

  name                = "${var.nameprefix}-vnet" 

  location            = azurermresourcegroup.rg.location 

  resourcegroupname = azurermresourcegroup.rg.name 

  addressspace       = ["10.50.0.0/16"] 

  tags                = var.tags 

} 

 

 

resource "azurermsubnet" "subnet" { 

  name                 = "${var.nameprefix}-subnet" 

  resourcegroupname  = azurermresourcegroup.rg.name 

  virtualnetworkname = azurermvirtualnetwork.vnet.name 

  addressprefixes     = ["10.50.1.0/24"] 

} 

  

resource "azurermnetworksecuritygroup" "nsg" { 

  name                = "${var.nameprefix}-nsg" 

  location            = azurermresourcegroup.rg.location 

  resourcegroupname = azurermresourcegroup.rg.name 

  

  securityrule { 

    name                       = "Allow-SSH" 

    priority                   = 100 

    direction                  = "Inbound" 

    access                     = "Allow" 

    protocol                   = "Tcp" 

    sourceportrange          = "" 

    destinationportrange     = "22" 

    sourceaddressprefixes    = var.allowedsships 

    destinationaddressprefix = "" 

  } 

  

  # Uncomment ONLY for POC; prefer Bastion or private access in real envs 

  # securityrule { 

  #   name                       = "Allow-RDP" 

  #   priority                   = 110 

  #   direction                  = "Inbound" 

  #   access                     = "Allow" 

  #   protocol                   = "Tcp" 

  #   sourceportrange          = "" 

  #   destinationportrange     = "3389" 

  #   sourceaddressprefixes    = var.allowedrdpips 

  #   destinationaddressprefix = "" 

  # } 

  

  tags = var.tags 

} 

  

resource "azurermpublicip" "pip" { 

  name                = "${var.nameprefix}-pip" 

  location            = azurermresourcegroup.rg.location 

  resourcegroupname = azurermresourcegroup.rg.name 

  allocationmethod   = "Static" 

  sku                 = "Standard" 

  tags                = var.tags 

} 

  

resource "azurermnetworkinterface" "nic" { 

  name                = "${var.nameprefix}-nic" 

  location            = azurermresourcegroup.rg.location 

  resourcegroupname = azurermresourcegroup.rg.name 

 

 

  ipconfiguration { 

    name                          = "ipconfig1" 

    subnetid                     = azurermsubnet.subnet.id 

    privateipaddressallocation = "Dynamic" 

    publicipaddressid          = azurermpublicip.pip.id 

  } 

  

  tags = var.tags 

} 

  

resource "azurermnetworkinterfacesecuritygroupassociation" "nicnsg" { 

  networkinterfaceid      = azurermnetworkinterface.nic.id 

  networksecuritygroupid = azurermnetworksecuritygroup.nsg.id 

} 

  

# Reference the Packer Managed Image 

data "azurermimage" "packerimg" { 

  name                = var.managedimagename 

  resourcegroupname = var.imagerg 

} 

 

 

resource "randompassword" "admin" { 

  length  = 18 

  special = true 

} 

  

resource "azurermlinuxvirtualmachine" "vm" { 

  name                = "${var.nameprefix}-vm" 

  resourcegroupname = azurermresourcegroup.rg.name 

  location            = azurermresourcegroup.rg.location 

  size                = var.vmsize 

  adminusername      = var.adminusername 

  adminpassword      = randompassword.admin.result 

 

 

  disablepasswordauthentication = false 

 

 

  networkinterfaceids = [ 

    azurermnetworkinterface.nic.id 

  ] 

 

 

  sourceimageid = data.azurermimage.packerimg.id 

 

 

  osdisk { 

    name                 = "${var.nameprefix}-osdisk" 

    caching              = "ReadWrite" 

    storageaccounttype = "PremiumLRS" 

    disksizegb         = 64 

  } 

  

  tags = var.tags 

} 

  

3.2 terraform/variables.tf 

  

variable "subscriptionid" { type = string } 

variable "tenantid"       { type = string } 

variable "clientid"       { type = string } 

variable "clientsecret"   { type = string, sensitive = true } 

  

variable "location"        { type = string  default = "eastus" } 

variable "rgname"         { type = string  default = "rg-image-poc" } 

variable "imagerg"        { type = string  default = "rg-image-poc" } 

variable "managedimagename" { type = string default = "img-ubuntu-22" } 

  

variable "nameprefix"     { type = string  default = "imgpoc" } 

variable "vmsize"         { type = string  default = "StandardD2sv5" } 

variable "adminusername"  { type = string  default = "azureuser" } 

 

 

variable "allowedsships" { 

  type    = list(string) 

  default = ["<your-public-ip>/32"] # replace 

} 

 

 

variable "allowedrdp_ips" { 

  type    = list(string) 

  default = ["<your-public-ip>/32"] # replace if enabling RDP rule 

} 

  

variable "tags" { 

  type = map(string) 

  default = { 

    Project     = "ImagePOC" 

    Owner       = "DevOps" 

    Environment = "Dev" 

  } 

} 

  

3.3 terraform/outputs.tf 

  

output "publicip" { 

  value = azurermpublicip.pip.ipaddress 

} 

  

output "adminusername" { 

  value = var.adminusername 

} 

  

output "adminpassword" { 

  value     = randompassword.admin.result 

  sensitive = true 

} 

  

3.4 terraform/envs/dev/terraform.tfvars 

  

subscriptionid     = "<SUBSCRIPTIONID>" 

tenantid           = "<TENANTID>" 

clientid           = "<CLIENTID>" 

clientsecret       = "<CLIENTSECRET>" 

  

location            = "eastus" 

rgname             = "rg-image-poc" 

imagerg            = "rg-image-poc" 

managedimagename  = "img-ubuntu-22" 

  

nameprefix         = "imgpoc" 

vmsize             = "StandardD2sv5" 

adminusername      = "azureuser" 

allowedsships     = ["<YOURIP>/32"] 

# allowedrdpips   = ["<YOUR_IP>/32"]  # uncomment if you enable RDP rule 

`` 

  

4) Run Terraform (create VM from the image) 

  

cd terraform 

terraform init 

terraform fmt 

terraform validate 

  

terraform plan -var-file="envs/dev/terraform.tfvars" 

terraform apply -var-file="envs/dev/terraform.tfvars" -auto-approve 

  

Outputs will show the public_ip. Test: 

  

ssh azureuser@<publicip> 

# password printed in "adminpassword" output (use 'terraform output' to read) 

  

If you baked XRDP into the image and opened 3389: 

Plain Text 

mstsc -> <public_ip>   (Windows RDP) 

 

 

Security tip: Prefer Azure Bastion or private access for anything beyond POC. 

5) (Optional) Switch to Shared Image Gallery (SIG) 

If you want to promote the image to SIG for versioning/scale: 

Add a post-processor in Packer (or use Packer‚Äôs azure-sig builder) 

In Terraform, replace the data "azurerm_image" with a data "azurerm_shared_image" + data "azurerm_shared_image_version" and set source_image_id accordingly. 

I can generate those snippets when you‚Äôre ready. 

6) Common pitfalls & fixes 

Packer auth fails ‚Üí ensure SP has Contributor on image_rg and Packer‚Äôs temp_rg. 

Terraform can‚Äôt find image ‚Üí check managed_image_name and image_rg match Packer output. 

RDP login fails ‚Üí ensure XRDP + XFCE installed and Xwrapper fix (you solved earlier). 

Ports blocked ‚Üí verify NSG inbound rules and that the NIC is associated with NSG. 

7) Next: Automate in Azure DevOps (summary) 

Later, create: 

Service connection with the same SP 

Pipeline stages: 

Validate/build Packer image 

Terraform plan 

Manual approval 

Terraform apply 

I can provide a complete azure-pipelines.yml when you‚Äôre ready. 

8) What would you like me to generate next? 

üîß SIG version Packer+Terraform variant 

üîê Policy/Tag guardrails (Azure Policy + TF) 

üîÑ Destroy scripts to clean up resources 

üß™ Shell tests to verify image contents post-boot 

üß± Terraform module structure (network, compute, image as modules) 

Given your DevSecOps and governance focus, I recommend we add: 

Checkov/TFSec scan in pipeline before packer build 

Enforce mandatory tags + diagnostics via Azure Policy at the RG 

Want me to add pipeline YAML plus a Makefile to streamline local runs? 

 